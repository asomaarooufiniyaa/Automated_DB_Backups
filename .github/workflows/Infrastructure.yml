name: Complete Infrastructure & Deployment Pipeline

on:
  push:
    branches:
      - main
    paths:
      - 'terraforrm/**'
      - 'ansible/**'
      - 'app/**'
      - '.github/workflows/deploy.yml'
  
  workflow_dispatch:

env:
  AWS_REGION: eu-north-1  
  TF_VERSION: 1.5.0
  ANSIBLE_VERSION: 2.15.0

jobs:
  # ==========================================
  # Job 1: Terraform
  # ==========================================
  terraform:
    name: Provision Infrastructure
    runs-on: ubuntu-latest
    timeout-minutes: 20

    outputs:
      server_ip: ${{ steps.tf_output.outputs.server_ip }}
      s3_bucket: ${{ steps.tf_output.outputs.s3_bucket }}

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup SSH Key for Terraform
        run: |
          mkdir -p terraforrm/keys
          echo "${{ secrets.SSH_PUBLIC_KEY }}" > terraforrm/keys/mykey.pub
          chmod 644 terraforrm/keys/mykey.pub

      - name: Terraform Init
        working-directory: ./terraforrm
        run: terraform init

      - name: Terraform Validate
        working-directory: ./terraforrm
        run: terraform validate

      - name: Terraform Plan
        working-directory: ./terraforrm
        env:
          TF_VAR_public_key: ${{ secrets.SSH_PUBLIC_KEY }}
        run: terraform plan -out=tfplan

      - name: Terraform Apply
        working-directory: ./terraforrm
        run: terraform apply -auto-approve tfplan

      - name: Get Terraform Outputs
        id: tf_output
        working-directory: ./terraforrm
        run: |
          SERVER_IP=$(terraform output -raw server_ip)
          S3_BUCKET=$(terraform output -raw s3_bucket_name)

          echo "server_ip=${SERVER_IP}" >> $GITHUB_OUTPUT
          echo "s3_bucket=${S3_BUCKET}" >> $GITHUB_OUTPUT
          
          echo "Server IP: ${SERVER_IP}"
          echo "S3 Bucket: ${S3_BUCKET}"

      - name: Wait for EC2 Instance
        run: |
          echo "Waiting 90 seconds for EC2 instance to be ready..."
          sleep 90

  # ==========================================
  # Job 2: Ansible
  # ==========================================
  ansible:
    name: Configure & Deploy Application
    runs-on: ubuntu-latest
    needs: terraform

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install Ansible
        run: |
          pip install ansible==${{ env.ANSIBLE_VERSION }}
          ansible --version

      - name: Setup SSH Key for Ansible
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ needs.terraform.outputs.server_ip }} >> ~/.ssh/known_hosts

      - name: Update Ansible Inventory
        run: |
          cat > ansible/inventories/hosts.ini << EOF
          [web_servers]
          ${{ needs.terraform.outputs.server_ip }} ansible_user=ubuntu ansible_ssh_private_key_file=~/.ssh/id_rsa
          EOF
          cat ansible/inventories/hosts.ini

      - name: Test Ansible Connection
        working-directory: ./ansible
        run: ansible all -i inventories/hosts.ini -m ping

      - name: Run Ansible Playbook - Setup Docker
        working-directory: ./ansible
        run: ansible-playbook -i inventories/hosts.ini playbooks/setup.yml

      - name: Run Ansible Playbook - Deploy Application
        working-directory: ./ansible
        env:
          DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
          DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}
        run: |
          ansible-playbook -i inventories/hosts.ini playbooks/deploy.yml \
            -e "docker_username=${DOCKER_USERNAME}" \
            -e "docker_password=${DOCKER_PASSWORD}"

      - name: Verify Deployment
        run: |
          SERVER_IP=${{ needs.terraform.outputs.server_ip }}
          echo "Verifying deployment on ${SERVER_IP}..."
          
          ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa ubuntu@${SERVER_IP} << 'EOF'
            echo "Running containers:"
            docker ps
          EOF

          echo "Checking Nginx..."
          sleep 10
          if curl -f http://${SERVER_IP}; then
            echo "Nginx is responding!"
          else
            echo "Warning: Nginx not responding yet"
          fi

  # ==========================================
  # Job 3: Summary
  # ==========================================
  summary:
    name: Deployment Summary
    runs-on: ubuntu-latest
    needs: [terraform, ansible]
    if: always()

    steps:
      - name: Generate Summary
        run: |
          echo "# Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Infrastructure" >> $GITHUB_STEP_SUMMARY
          echo "- **Server IP:** \`${{ needs.terraform.outputs.server_ip }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **S3 Bucket:** \`${{ needs.terraform.outputs.s3_bucket }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Region:** \`${{ env.AWS_REGION }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Services" >> $GITHUB_STEP_SUMMARY
          echo "- MongoDB (Port 27017)" >> $GITHUB_STEP_SUMMARY
          echo "- Backend API (Port 3000)" >> $GITHUB_STEP_SUMMARY
          echo "- Nginx (Port 80)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Access" >> $GITHUB_STEP_SUMMARY
          echo "- **App URL:** http://${{ needs.terraform.outputs.server_ip }}" >> $GITHUB_STEP_SUMMARY
          echo "- **SSH:** \`ssh ubuntu@${{ needs.terraform.outputs.server_ip }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Notes" >> $GITHUB_STEP_SUMMARY
          echo "- Infrastructure deployed automatically with Terraform" >> $GITHUB_STEP_SUMMARY
          echo "- App deployed and verified via Ansible" >> $GITHUB_STEP_SUMMARY
          echo "- Backup jobs can be added later using cron or AWS Lambda" >> $GITHUB_STEP_SUMMARY
